# PDF Viewer in Rust - アーキテクチャ図とコード関係

## 全体アーキテクチャ概要図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PDF Viewer Application                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                main.rs                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │   Dioxus App    │  │   State Mgmt    │  │   Event Loop    │              │
│  │   Components    │  │   (Signals)     │  │   (async/spawn) │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────┘
           │                        │                        │
           ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│      UI         │    │     Storage     │    │      PDF        │
│   Components    │    │   Persistence   │    │   Processing    │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │  Popups     │ │    │ │ Flashcards  │ │    │ │   Render    │ │
│ │ ├flashcards │ │    │ │ ├bookmarks  │ │    │ │ ├text_ext  │ │
│ │ ├bookmarks  │ │    │ │ ├markers    │ │    │ │ ├coord_cvt │ │
│ │ ├recent_file│ │    │ │ ├recent_file│ │    │ │ └utils     │ │
│ │ └markers    │ │    │ │ ├api_keys   │ │    │ └─────────────┘ │
│ └─────────────┘ │    │ │ └config     │ │    └─────────────────┘
│                 │    │ └─────────────┘ │              │
└─────────────────┘    └─────────────────┘              ▼
           │                        │              ┌─────────────────┐
           ▼                        ▼              │       AI        │
┌─────────────────┐    ┌─────────────────┐         │   Integration   │
│      Types      │    │   File System   │         │                 │
│                 │    │      (dirs)     │         │ ┌─────────────┐ │
│ ┌─────────────┐ │    │                 │         │ │   Search    │ │
│ │ FlashCard   │ │    │ ~/.config/      │         │ │ ├providers │ │
│ │ Bookmark    │ │    │ pdf-viewer/     │         │ │ └gemini   │ │
│ │ Marker      │ │    │ ├flashcards.json│         │ │   chatgpt  │ │
│ │ TextElement │ │    │ ├bookmarks.json │         │ │   claude   │ │
│ │ PdfPageData │ │    │ ├markers_*.json │         │ └─────────────┘ │
│ └─────────────┘ │    │ └api_keys.json  │         └─────────────────┘
└─────────────────┘    └─────────────────┘
```

## モジュール依存関係図

```
main.rs
├── types/mod.rs (データ構造定義)
│   ├── FlashCard
│   ├── ReadingBookmark  
│   ├── PositionMarker
│   ├── TextElement
│   ├── PdfPageData
│   ├── RotationAngle
│   └── AIProvider
│
├── pdf/ (PDF処理)
│   ├── mod.rs (公開インターフェース)
│   ├── render.rs
│   │   ├── render_pdf_page_with_text()
│   │   ├── get_pdf_info()
│   │   └── parallel_rendering()
│   └── utils.rs
│       ├── get_pdfium_library_path()
│       ├── filter_overlapping_text()
│       └── coordinate_conversion()
│
├── ai/ (AI統合)
│   ├── mod.rs (プロバイダー統合)
│   ├── search.rs
│   │   ├── search_with_ai() 
│   │   └── detailed_search_with_ai()
│   └── providers.rs
│       ├── search_with_gemini()
│       ├── search_with_chatgpt()
│       └── search_with_claude()
│
├── storage/ (データ永続化)
│   ├── mod.rs (ストレージ統合)
│   ├── config.rs (設定ディレクトリ管理)
│   ├── flashcards.rs
│   │   ├── load_flashcards()
│   │   ├── save_flashcards()
│   │   ├── add_flashcard()
│   │   └── append_detailed_explanation()
│   ├── recent_files.rs (ファイル履歴)
│   ├── api_keys.rs (APIキー管理)
│   ├── bookmarks.rs (読書進捗)
│   └── markers.rs (位置マーカー)
│
└── ui/ (UIコンポーネント)
    ├── mod.rs (UI統合)
    └── components/
        └── popups/
            ├── mod.rs (ポップアップ統合)
            ├── flashcards.rs (単語帳UI)
            ├── recent_files.rs (履歴UI)
            ├── bookmarks.rs (ブックマークUI)
            └── markers.rs (マーカーUI)
```

## データフロー図

```
┌─────────────────┐
│   User Input    │
│                 │
│ ┌─────────────┐ │
│ │ File Select │ │ ──┐
│ │ Text Search │ │   │
│ │ Text Select │ │   │
│ │ Click/Touch │ │   │
│ └─────────────┘ │   │
└─────────────────┘   │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                    main.rs Event Handlers                  │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ PDF Load    │ │ AI Search   │ │ UI Actions  │          │
│  │ Handler     │ │ Handler     │ │ Handler     │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
       │                    │                    │
       ▼                    ▼                    ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ PDF Module  │    │ AI Module   │    │ Storage     │
│             │    │             │    │ Module      │
│ ┌─────────┐ │    │ ┌─────────┐ │    │ ┌─────────┐ │
│ │Render   │ │    │ │API Call │ │    │ │JSON I/O │ │
│ │Extract  │ │    │ │Response │ │    │ │File Ops │ │
│ │Convert  │ │    │ │Process  │ │    │ │Config   │ │
│ └─────────┘ │    │ └─────────┘ │    │ └─────────┘ │
└─────────────┘    └─────────────┘    └─────────────┘
       │                    │                    │
       ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────┐
│                    Signal Updates                           │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ page_cache  │ │ search_res  │ │ flashcards  │          │
│  │ pdf_path    │ │ is_searching│ │ bookmarks   │          │
│  │ rotations   │ │ providers   │ │ markers     │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    UI Re-render                             │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ PDF Pages   │ │ Search UI   │ │ Popups      │          │
│  │ Text Overlay│ │ Results     │ │ Lists       │          │
│  │ Markers     │ │ Buttons     │ │ Forms       │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 状態管理アーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                        Dioxus Signal System                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐  │
│  │   Core State    │    │   UI State      │    │  Cache      │  │
│  │                 │    │                 │    │  State      │  │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────┐ │  │
│  │ │ pdf_path    │ │    │ │ popups_show │ │    │ │page_    │ │  │
│  │ │ total_pages │ │    │ │ is_loading  │ │    │ │cache    │ │  │
│  │ │ current_pg  │ │    │ │ is_search   │ │    │ │loaded_  │ │  │
│  │ └─────────────┘ │    │ │ marker_mode │ │    │ │pdf_path │ │  │
│  └─────────────────┘    │ └─────────────┘ │    │ └─────────┘ │  │
│                         └─────────────────┘    └─────────────┘  │
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐  │
│  │   Data State    │    │   Search State  │    │  Config     │  │
│  │                 │    │                 │    │  State      │  │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────┐ │  │
│  │ │ flashcards  │ │    │ │ query       │ │    │ │api_keys │ │  │
│  │ │ bookmarks   │ │    │ │ result      │ │    │ │provider │ │  │
│  │ │ markers     │ │    │ │ provider    │ │    │ │rotation │ │  │
│  │ │ recent_file │ │    │ │ is_detailed │ │    │ └─────────┘ │  │
│  │ └─────────────┘ │    │ └─────────────┘ │    └─────────────┘  │
│  └─────────────────┘    └─────────────────┘                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Reactive Propagation                        │
│                                                                 │
│  Signal Change → use_memo() → Component Re-render → UI Update   │
│                                                                 │
│  例: flashcards.set() → flashcard_list() → popup refresh       │
└─────────────────────────────────────────────────────────────────┘
```

## 非同期処理フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    Async Processing Flow                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐      ┌─────────────────┐                  │
│  │   User Action   │ ───► │  Event Handler  │                  │
│  │                 │      │                 │                  │
│  │ ┌─────────────┐ │      │ ┌─────────────┐ │                  │
│  │ │ Search      │ │      │ │ spawn(async)│ │                  │
│  │ │ File Open   │ │      │ │ move {...}  │ │                  │
│  │ │ PDF Process │ │      │ └─────────────┘ │                  │
│  │ └─────────────┘ │      └─────────────────┘                  │
│  └─────────────────┘                │                          │
│                                     ▼                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │               Tokio Runtime                             │   │
│  │                                                         │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │ AI API Call │ │ File I/O    │ │ PDF Render  │       │   │
│  │  │             │ │             │ │             │       │   │
│  │  │ reqwest::   │ │ std::fs::   │ │ pdfium::    │       │   │
│  │  │ Client      │ │ read/write  │ │ render      │       │   │
│  │  │ .send()     │ │ .await      │ │ .await      │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                │                               │
│                                ▼                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │             Result Processing                           │   │
│  │                                                         │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │   │
│  │  │ Success     │ │ Error       │ │ Update      │       │   │
│  │  │ Handle      │ │ Handle      │ │ Storage     │       │   │
│  │  │             │ │             │ │             │       │   │
│  │  │ signal.set()│ │ error_msg   │ │ save_data() │       │   │
│  │  │ update_ui() │ │ .set()      │ │ reload()    │       │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘       │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## コンポーネント相互作用図

```
┌─────────────────────────────────────────────────────────────────┐
│                     Component Interactions                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│                        main.rs (Root)                          │
│                             │                                   │
│       ┌─────────────────────┼─────────────────────┐             │
│       │                     │                     │             │
│       ▼                     ▼                     ▼             │
│ ┌─────────────┐     ┌─────────────┐     ┌─────────────┐         │
│ │   PDF       │     │   Search    │     │    File     │         │
│ │   Display   │     │   Panel     │     │   Control   │         │
│ │             │     │             │     │             │         │
│ │ ┌─────────┐ │     │ ┌─────────┐ │     │ ┌─────────┐ │         │
│ │ │ Pages   │ │     │ │ Query   │ │     │ │ Open    │ │         │
│ │ │ Text    │ │     │ │ Results │ │     │ │ Recent  │ │         │
│ │ │ Overlay │ │     │ │ API Cfg │ │     │ │ Control │ │         │
│ │ └─────────┘ │     │ └─────────┘ │     │ └─────────┘ │         │
│ └─────────────┘     └─────────────┘     └─────────────┘         │
│       │                     │                     │             │
│       └─────────────────────┼─────────────────────┘             │
│                             │                                   │
│                             ▼                                   │
│                   ┌─────────────────┐                          │
│                   │   Popup Layer   │                          │
│                   │                 │                          │
│                   │ ┌─────────────┐ │                          │
│                   │ │ Flashcards  │ │                          │
│                   │ │ Bookmarks   │ │                          │
│                   │ │ Markers     │ │                          │
│                   │ │ Recent Files│ │                          │
│                   │ └─────────────┘ │                          │
│                   └─────────────────┘                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

Popup Communication Pattern:
┌─────────────┐     show_popup     ┌─────────────┐
│   Parent    │ ──────────────────► │   Popup     │
│ Component   │                    │ Component   │
│             │ ◄─────────────────  │             │
└─────────────┘    close_popup     └─────────────┘

Signal Sharing Pattern:
┌─────────────┐     Signal<T>      ┌─────────────┐
│ Component A │ ◄─────────────────► │ Component B │
│             │                    │             │
│  .get()     │     .set()         │   .get()    │
│  .set()     │ ◄─────────────────► │   .set()    │
└─────────────┘                    └─────────────┘
```

## ライブラリ依存関係図

```
┌─────────────────────────────────────────────────────────────────┐
│                   External Dependencies                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   Dioxus    │    │   Tokio     │    │  PDFium     │         │
│  │             │    │             │    │             │         │
│  │ ┌─────────┐ │    │ ┌─────────┐ │    │ ┌─────────┐ │         │
│  │ │UI       │ │    │ │Runtime  │ │    │ │Render   │ │         │
│  │ │Signals  │ │    │ │Async    │ │    │ │Text Ext │ │         │
│  │ │Desktop  │ │    │ │Spawn    │ │    │ │PDF Parse│ │         │
│  │ └─────────┘ │    │ └─────────┘ │    │ └─────────┘ │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   Reqwest   │    │    Serde    │    │    Dirs     │         │
│  │             │    │             │    │             │         │
│  │ ┌─────────┐ │    │ ┌─────────┐ │    │ ┌─────────┐ │         │
│  │ │HTTP     │ │    │ │JSON     │ │    │ │Config   │ │         │
│  │ │Client   │ │    │ │Serialize│ │    │ │Paths    │ │         │
│  │ │Async    │ │    │ │Derive   │ │    │ │Cross    │ │         │
│  │ └─────────┘ │    │ └─────────┘ │    │ │Platform │ │         │
│  └─────────────┘    └─────────────┘    │ └─────────┘ │         │
│                                        └─────────────┘         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │    RFD      │    │   Base64    │    │   Chrono    │         │
│  │             │    │             │    │             │         │
│  │ ┌─────────┐ │    │ ┌─────────┐ │    │ ┌─────────┐ │         │
│  │ │File     │ │    │ │Encode   │ │    │ │DateTime │ │         │
│  │ │Dialog   │ │    │ │Decode   │ │    │ │Format   │ │         │
│  │ │Async    │ │    │ │Image    │ │    │ │UTC      │ │         │
│  │ └─────────┘ │    │ └─────────┘ │    │ └─────────┘ │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

## パフォーマンス最適化ポイント

```
┌─────────────────────────────────────────────────────────────────┐
│                  Performance Optimization                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │  Memory Mgmt    │    │   Computation   │                    │
│  │                 │    │                 │                    │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │                    │
│  │ │Page Cache   │ │    │ │use_memo()   │ │                    │
│  │ │HashMap<T>   │ │    │ │Memoization  │ │                    │
│  │ │Clear on     │ │    │ │Computed     │ │                    │
│  │ │New PDF      │ │    │ │Properties   │ │                    │
│  │ └─────────────┘ │    │ └─────────────┘ │                    │
│  └─────────────────┘    └─────────────────┘                    │
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │  Async Parallel │    │  UI Efficiency  │                    │
│  │                 │    │                 │                    │
│  │ ┌─────────────┐ │    │ ┌─────────────┐ │                    │
│  │ │Semaphore    │ │    │ │Conditional  │ │                    │
│  │ │CPU Cores    │ │    │ │Rendering    │ │                    │
│  │ │Batch Render │ │    │ │Signal Dep   │ │                    │
│  │ │Multi-task   │ │    │ │Virtual DOM  │ │                    │
│  │ └─────────────┘ │    │ └─────────────┘ │                    │
│  └─────────────────┘    └─────────────────┘                    │
│                                                                 │
│  Critical Path:                                                 │
│  User Input → Signal Change → Memo Update → Component Render   │
│                                                                 │
│  Bottlenecks:                                                   │
│  • PDF Rendering (I/O bound)                                   │
│  • AI API Calls (Network bound)                                │
│  • Large JSON Serialization (CPU bound)                       │
└─────────────────────────────────────────────────────────────────┘
```

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30b3\u30fc\u30c9\u95a2\u4fc2\u56f3\u3092\u4f5c\u6210", "status": "completed", "priority": "medium", "id": "create-code-relationship-diagram"}]